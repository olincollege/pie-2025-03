<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Software/Firmware Overview - Project AURA"
    />
    <title>Software/Firmware Overview - Project AURA</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header class="header">
      <nav class="nav" role="navigation" aria-label="Main navigation">
        <div class="nav-container">
          <a href="index.html" class="nav-logo">Project AURA</a>
          <button
            class="nav-toggle"
            aria-label="Toggle navigation menu"
            aria-expanded="false"
            aria-controls="nav-menu"
          >
            <span class="hamburger"></span>
            <span class="hamburger"></span>
            <span class="hamburger"></span>
          </button>
          <ul class="nav-menu" id="nav-menu">
            <li class="nav-item">
              <a href="overview.html" class="nav-link">Overview</a>
            </li>
            <li class="nav-item">
              <a href="design-process.html" class="nav-link">Design Process</a>
            </li>
            <li class="nav-item">
              <a href="mechanical.html" class="nav-link">Mechanical</a>
            </li>
            <li class="nav-item">
              <a href="electrical.html" class="nav-link">Electrical</a>
            </li>
            <li class="nav-item">
              <a href="software.html" class="nav-link nav-link-active"
                >Software</a
              >
            </li>
          </ul>
        </div>
      </nav>
    </header>

    <main id="main-content" class="page-content">
      <section class="section-padding">
        <div class="container">
          <div class="text-center mb-16">
            <h1 class="page-title">Software/Firmware Overview</h1>
            <p class="page-subtitle">The brains of the project</p>
            <p style="margin-top: var(--spacing-md)">
              <a
                href="https://github.com/Zaraius/AURA/tree/main"
                class="btn btn-outline"
                target="_blank"
                rel="noopener noreferrer"
              >
                View GitHub Repository
              </a>
            </p>
          </div>

          <div class="card mb-12">
            <h2 class="card-title">Software System Diagram</h2>
            <div class="diagram-container">
              <img
                src="assets/SoftwareSystemDiagram.png"
                alt="Software System Diagram showing ROS2 publisher-subscriber architecture with sensor inputs and actuator outputs"
                class="diagram-image"
              />
            </div>
          </div>

          <div class="card">
            <div class="text-content">
              <p>
                Given the scope of our project, we initially planned to
                incorporate a list of functionalities, including target
                tracking, path planning, and object avoidance. To achieve the
                flexibility of adding electronic components while having enough
                computational power, we chose to run the ROS2 system on a
                Raspberry Pi 4b as the central processing unit of the whole
                robot. This firmware architecture conveniently sets up a
                publisher-subscriber software model that enables effective
                messaging between sensors and actuators. As shown in the
                diagram, all the sensor inputs come in from the left, publishing
                data to ROS, and are forwarded to the actuator subscribers. Most
                electronics are controlled directly through pins on the
                Raspberry Pi so there aren't many software dependencies. OpenCV
                serves as the only external dependency of this project, serving
                as the vision tracker to process camera output.
              </p>
            </div>
          </div>

          <div class="design-decisions">
            <h2 class="section-heading text-center">Challenges</h2>

            <div class="decision-cards">
              <div class="decision-card">
                <div class="decision-header">
                  <h3>UWB Modules</h3>
                </div>
                <p>
                  We attempted to use 4 UWB modules to achieve target
                  localization for a certain radius around the robot by mounting
                  3 modules as anchors onto the robot and 1 as the tag held by
                  the target person. However, when testing the system after
                  mounting it under the robot, we found that the localization
                  readings were inconsistent and lost the target many times,
                  even within the radius. There were inaccurate readings coming
                  from all 3 anchors because of interference, including signal
                  multipath due to metal motor mounts and NLOS
                  (non-line-of-sight).
                </p>
                <p><strong>Solution:</strong></p>
                <p>
                  Although we tried calibration of the anchor modules to account
                  for any internal clock drifting and added a Kalman filter for
                  signal processing, those issues above still remain. We also
                  found out that the nature of this layout of UWB modules is not
                  optimal because the positions of the anchors are not far
                  enough to tolerate any missing anchors. Although placing the
                  anchors in fixed locations of an indoor environment will solve
                  all these issues, such a setup does not meet our initial
                  design requirement of target tracking in any environment, both
                  indoor and outdoor. We decided to pivot to use computer vision
                  for target tracking instead.
                </p>
              </div>

              <div class="decision-card">
                <div class="decision-header">
                  <h3>Encoder sampling rate</h3>
                </div>
                <p>
                  For each of the two driving motors, we have a rotary encoder
                  on the wheels to keep track of the physical states of the
                  wheels, such as the number of rotations and velocity. It is
                  critical to make sure the encoder is outputting accurate
                  counts because not only does the motor's PID feedback control
                  loop depend on it, but the autonomous path planning program
                  also relies on the readings to generate the robot's odometry
                  for planning where to move next. Our encoders are one of the
                  simpler types, where they directly connect to the pin to
                  indicate if a tick has passed or not. The encoder reading
                  seemed to be fine in the early stage of the project. However,
                  once we started running the robot full speed and tracking the
                  robot's odometry, we observed irrational behavior where the
                  encoder readings increased much more slowly than they should,
                  and even decreased sometimes. This is caused by the limit of
                  the Raspberry Pi's sampling rate on encoder signals, leading
                  to missing counts and miscounts when wheels spin really fast.
                </p>
                <p><strong>Solution:</strong></p>
                <p>
                  We attempted to increase the sampling rate of the Raspberry
                  Pi's timer to the upper limit, but it wasn't enough to match
                  the max speed of our actual wheels. We researched more and
                  concluded that there wouldn't be a simple software fix for our
                  encoder. The lesson we learned is that there needs to be a
                  separate counter or an internal counting circuit for each
                  encoder to keep track of the ticks at a high sampling rate at
                  the low-level electronics. We can achieve them with a
                  real-time microcontroller or use absolute encoders instead.
                </p>
              </div>

              <div class="decision-card">
                <div class="decision-header">
                  <h3>Stepper motor CPU thread starvation → concurrency</h3>
                </div>
                <p>
                  The control of the 2 drive motors and the 2 stepper motors is
                  very straightforward: We control the drive motors by sending
                  PWM signals to indicate speed and digital signals to indicate
                  directions. However, steppers are controlled by sending one
                  HIGH signal and one LOW signal for every single step when
                  turning. Since we had to increase the stepper step size to
                  avoid chain-skipping on the stepper when turning a large
                  angle, the step sizes become too large in a for loop, which
                  occupies the main thread. This led to issues where the left
                  and right steppers turn one after another, as well as the
                  driving motor only moving after the steppers finished turning,
                  because the for loops are blocking the execution sequences,
                  thus causing resource starvation.
                </p>
                <p><strong>Solution:</strong></p>
                <p>
                  We turned the controls of 2 steppers and 2 drive motors all
                  into individual, independent threads to achieve concurrent
                  control. This effectively solved the problem of CPU starvation
                  and awkward sequential execution by sending signal commands
                  nearly all at once instead of one after another.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer" role="contentinfo">
      <div class="container">
        <h3 class="footer-title">Project AURA</h3>
        <p class="footer-description">
          A smart, autonomous cart that carries your heavy stuff and follows you
          so you never have to haul it yourself.
        </p>
        <div class="footer-bottom">
          <p class="footer-copyright">
            © <span id="current-year"></span> Project AURA. Principles of
            Integrated Engineering.
          </p>
          <div class="footer-links">
            <a
              href="https://github.com/Zaraius/AURA.git"
              class="footer-link"
              target="_blank"
              rel="noopener noreferrer"
              >GitHub</a
            >
          </div>
        </div>
      </div>
    </footer>

    <script src="js/main.js"></script>
  </body>
</html>
